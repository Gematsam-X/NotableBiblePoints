import{getValue as e,deleteValue as o,setValue as t}from"./indexedDButils.js";import i from"./toast.js";import n from"./isOnline.js";const a=document.querySelector(".refreshNotes");async function r(){try{const n=await e("userNotes")||[],a=await e("deletedNotes")||[];if(0===n.length&&0===a.length)return console.log("Nessuna nota da sincronizzare."),i("Sincronizzazione completata!",2e3),!0;let s;try{s=await Backendless.Data.of("NotableBiblePoints").findFirst()}catch(e){return console.error("Errore nel recupero del record dal server:",e),i(`Errore nel recupero delle tue note dal cloud, continueremo a provare. Non chiudere o ricaricare l'app. Dettagli: ${e}`,4500),window.setTimeout(r,3e3),!1}if(!s||!s.NotablePoints)throw console.log("Nessun record o punti notevoli trovati nel database."),i("Errore: database non trovato. Non riproveremo. Rivolgiti allo sviluppatore se il problema persiste.",3500),new Error("Nessun record trovato nel database, o campo NotablePoints inesistente.");const l=s.NotablePoints;let c=l.filter((e=>!a.some((o=>o.id===e.id))));const d=n.filter((e=>!l.some((o=>o.id===e.id))));return c.push(...d),c=c.map((e=>{const o=n.find((o=>o.id===e.id)),t=l.find((o=>o.id===e.id&&o.owner===e.owner));if(!o||!t)return e;const i=void 0!==o.updatedAt,a=void 0!==t.updatedAt;return i||a?i&&!a?o:!i&&a?t:o.updatedAt>t.updatedAt?o:t:t})),s.NotablePoints=c,await Backendless.Data.of("NotableBiblePoints").save(s),await o("deletedNotes"),await t("userNotes",c),console.log("Sincronizzazione completata con successo!"),i("Sincronizzazione completata!",2e3),!0}catch(e){console.error("Errore durante la sincronizzazione:",e),window.setTimeout(r,1500)}}!function(){let e=!1;setInterval((async()=>{const o=await n();if(!e&&o){console.log("Connessione ripristinata. Sincronizzo i dati..."),i("Sincronizzazione in corso. Non chiudere o ricaricare l'app.",2e3),sessionStorage.setItem("canRefresh","false"),a.classList.contains("disabled")||a.classList.add("disabled");await r()?(sessionStorage.setItem("canRefresh","true"),a.classList.remove("disabled"),console.log("Sincronizzazione completata con successo!")):console.log("Sincronizzazione fallita, riprovo al prossimo ciclo.")}e=o}),3e3)}();