import{hideGif as e,showGif as o}from"./loadingGif.js";import t from"./toast.js";import{getValue as r,deleteValue as a}from"./indexedDButils.js";export async function deleteCurrentUser(){try{const a=await Backendless.UserService.getCurrentUser();if(console.log("Utente attuale:",a),!a)return void t("Nessun utente loggato.");o();if(!confirm("Questa azione Ã¨ irreversibile e cancella tutti i dati associati a questo account. Sei sicuro di voler proseguire ed eliminare il tuo account?"))return void e();const i=await r("userEmail");if(!i)return t("Errore: email utente non trovata."),void e();const n=await Backendless.Data.of("NotableBiblePoints").findFirst();if(!n||!n.NotablePoints)return t("Errore: dati non trovati."),void e();console.log("Dati attuali:",n.NotablePoints);const l=n.NotablePoints.filter((e=>e.owner!==i));console.log("Dati aggiornati:",l),n.NotablePoints=l,await Backendless.Data.of("NotableBiblePoints").save(n),console.log("Eliminazione utente con ID:",a.objectId),await Backendless.Data.of("Users").remove(a.objectId),logoutUser(!1)}catch(e){console.error("Errore nella cancellazione dell'account:",e),t("Errore durante l'eliminazione dell'account: "+e.message)}finally{e()}}export async function logoutUser(r=!0){r&&o();try{await Backendless.UserService.logout(),localStorage.removeItem("userEmail"),localStorage.removeItem("userToken"),await a("userNotes"),await a("deletedNotes"),localStorage.removeItem("userNotes"),localStorage.removeItem("deletedNotes"),window.location.href="login.html"}catch(e){console.error("Errore nel logout:",e),t("Errore durante il logout: "+e.message,4e3)}finally{e()}}export async function redirectToOriginPage(){if("false"===localStorage.getItem("isAuthenticated"))return void(window.location.href="login.html");const e=await new Promise((e=>{let o=0,t=!1;const r=()=>{document.referrer.startsWith(window.location.origin)&&document.referrer!==window.location.href?(t=!0,e(document.referrer)):(o++,o>10?e(null):history.back(),setTimeout((()=>{t||r()}),100))};r()}));e?(console.log("Ritornando a "+e),window.location.href=e):window.location.href="login.html"}