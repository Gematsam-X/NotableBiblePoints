import e from"./toast.js";import{getValue as t,setValue as o}from"./indexedDButils.js";import{showGif as n,hideGif as i}from"./loadingGif.js";const a=document.getElementById("toggleSearchMode"),r=document.getElementById("search-input"),s=document.getElementById("search-button"),l=document.getElementById("results-modal"),c=document.getElementById("results-content"),d=document.getElementById("close-modal");let m=await t("userNotes");async function u(){if(a.checked){const t=r.value.trim();if(!t)return r.blur(),e("Inserisci una parola o una frase da cercare."),void(l.style.display="none");if(/[<>&"']/.test(t))return r.blur(),e("Inserisci un termine di ricerca valido."),void(l.style.display="none");const a=await async function(t){if(t.length<3)return r.blur(),e("Inserisci almeno 3 caratteri per la ricerca."),void(l.style.display="none");if(!m||!m.length){if(!navigator.onLine)return alert("Connettersi a Internet."),[];n(),m=(await Backendless.Data.of("NotableBiblePoints").findFirst()).NotablePoints.filter((e=>e.owner===localStorage.getItem("userEmail"))),await o("userNotes",m),i()}const a=[],s=t.trim().split(/\s+/).filter(Boolean),c=1===s.length,d=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=c?new RegExp(`\\b${d}`,"gi"):null,h=s.map((e=>{const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\b${t}`,"gi")}));for(const e of m){let t=[],o=[];c&&u&&(t=[...e.content.matchAll(u)],o=[...e.title.matchAll(u)]);let n=0,i=0;for(const t of h)n+=[...e.content.matchAll(t)].length,i+=[...e.title.matchAll(t)].length;const r=t.length+o.length,s=n+i;if(r+s===0)continue;let l=e.title;c&&u&&(l=l.replace(u,(e=>`<mark>${e}</mark>`)));for(const e of h)l=l.replace(e,(e=>`<mark>${e}</mark>`));const d=[],m=e.content.split("\n");for(let e=0;e<m.length;e++){const t=m[e],o=c&&u&&u.test(t),n=h.some((e=>e.test(t)));if(!o&&!n)continue;let i=t;c&&u&&(i=i.replace(u,(e=>`<mark>${e}</mark>`)));for(const e of h)i=i.replace(e,(e=>`<mark>${e}</mark>`));const a=[m[e-2]||"",m[e-1]||"",i,m[e+1]||"",m[e+2]||""].map((e=>e.trim())).filter((e=>e.length>0)).join("<br>");d.push(a)}let p="";if(0===d.length){p=`<div class="content-preview">${e.content.split("\n").slice(0,5).map((e=>e.trim())).filter((e=>e)).join("<br>")}</div>`}const g=`\n      <div class="search-result">\n        <a class="redirect-link"\n           data-book="${e.book}"\n           data-chapter="${e.chapter}"\n           data-id="${e.id}">\n          <h2><strong>${e.book} ${e.chapter}:${e.verse}</strong></h2>\n        </a>\n        <h3><strong>${l}</strong></h3><br>\n        ${d.length>0?`<div class="matched-contexts">${d.join("<br><hr class='dashed'><br>")}</div>`:p}\n      </div>\n      <br><hr class="normal"><br>\n    `;let b=0;r>0&&s>0?b=3:r>0?b=2:s>0&&(b=1),a.push({html:g,matchScore:r+s,priority:b})}return a.sort(((e,t)=>t.priority!==e.priority?t.priority-e.priority:t.matchScore-e.matchScore)),l.style.display="block",a.map((e=>e.html))}(t);if(!a?.length)return r.blur(),e(`Nessuna occorrenza trovata per "${t}".`),void(l.style.display="none");c.innerHTML=`<h2>Occorrenze trovate:</h2>${a.join("<br>")}`,r.blur()}else!function(){if(!r)return r.blur(),void e("Inserisci un riferimento biblico valido (es. Genesi 1:1 o Genesi 1 1).");const t=r.value.split(/[\s:]+/),o=t[0].trim(),n=t[1]?.trim(),i=o.toLowerCase().replace(/\s+/g,""),a=p.filter((e=>e.toLowerCase().replace(/\s+/g,"").startsWith(i)));if(""===i)return r.blur(),void e("Digita il libro biblico ed eventualmente il capitolo nel campo in basso a destra. Puoi anche digitare solo le iniziali del libro (es. 'Gen' per 'Genesi').",4800);if(1===a?.length||"salmo"===i){const e="salmo"===i?"Salmi":a[0];sessionStorage.setItem("selectedBook",e);const t=p.indexOf(e);sessionStorage.setItem("selectedBook",p[t]),n&&!isNaN(n)?(sessionStorage.setItem("selectedChapter",parseInt(n)),window.location.href="notes.html"):window.location.href="chapters.html"}else a?.length>1?(r.blur(),e(`Il testo fornito non è univoco. Forse intendevi: ${a.join(" - ")}`)):(r.blur(),e("Il libro non è stato trovato. Verifica di aver scritto correttamente il nome."))}()}function h(e,t,o){sessionStorage.setItem("selectedBook",e),sessionStorage.setItem("selectedChapter",t),sessionStorage.setItem("selectedNoteId",o),console.log(sessionStorage.getItem("selectedNoteId"),sessionStorage.getItem("selectedChapter")),window.location.href="../html/notes.html"}new MutationObserver((e=>{for(const t of e)"childList"===t.type&&t.addedNodes.length>0&&document.querySelectorAll(".redirect-link").forEach((e=>{e.dataset.listenerAdded||(e.addEventListener("click",(()=>{h(e.dataset.book,e.dataset.chapter,e.dataset.id)})),e.dataset.listenerAdded="true")}))})).observe(l,{childList:!0,subtree:!0}),s.addEventListener("click",u);const p=["Genesi","Esodo","Levitico","Numeri","Deuteronomio","Giosuè","Giudici","Rut","1 Samuele","2 Samuele","1 Re","2 Re","1 Cronache","2 Cronache","Esdra","Neemia","Ester","Giobbe","Salmi","Proverbi","Ecclesiaste","Cantico dei Cantici","Isaia","Geremia","Lamentazioni","Ezechiele","Daniele","Osea","Gioele","Amos","Abdia","Giona","Michea","Naum","Abacuc","Sofonia","Aggeo","Zaccaria","Malachia","Matteo","Marco","Luca","Giovanni","Atti","Romani","1 Corinti","2 Corinti","Galati","Efesini","Filippesi","Colossesi","1 Tessalonicesi","2 Tessalonicesi","1 Timoteo","2 Timoteo","Tito","Filemone","Ebrei","Giacomo","1 Pietro","2 Pietro","1 Giovanni","2 Giovanni","3 Giovanni","Giuda","Rivelazione"];function g(){r.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."}document.addEventListener("keypress",(e=>{"Enter"===e.key&&document.activeElement===document.getElementById("search-input")&&u()})),r.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico...",a.addEventListener("change",(()=>{r.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."})),g(),a.addEventListener("change",(()=>{g(),localStorage.setItem("searchMode",a.checked)}));const b=localStorage.getItem("searchMode");null!==b&&(a.checked="true"===b,g()),d.addEventListener("click",(()=>{l.style.display="none",r.blur()})),document.addEventListener("click",(e=>{e.target===l&&(l.style.display="none")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(l.style.display="none",r.blur())}));