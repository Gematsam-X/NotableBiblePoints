import{isDarkTheme as e}from"./isDarkTheme.js";import{hideGif as t,showGif as o}from"./loadingGif.js";import n from"./toast.js";import{logoutUser as i}from"./logoutAndDelete.js";import{setValue as a,getValue as r,deleteValue as s}from"./indexedDButils.js";import l from"./isOnline.js";const c=document.querySelector(".refreshNotes"),d=sessionStorage.getItem("selectedBook"),u=parseInt(sessionStorage.getItem("selectedChapter")),m=document.querySelector(".notes-page-title"),v=`Punti notevoli del capitolo ${u} di ${d}`;async function p(){return!!await l()&&(!await r("userNotes")&&(!await r("userNotes")||void 0))}m&&(m.textContent=v,window.document.title=`${v} - NotableBiblePoints`);const g=document.querySelector(".modal");async function y(){const t=document.querySelector(".notesContainer");if(t){t.innerHTML="<p>Caricamento in corso...</p>",c.classList.add("disabled");try{const o=localStorage.getItem("userEmail"),i=await p()?(await Backendless.Data.of("NotableBiblePoints").findFirst()).NotablePoints:await r("userNotes");if(console.log(i,"allRecords"),!Array.isArray(i))return n("Errore: i dati non sono in formato corretto."),void(t.innerHTML="<p>Errore nei dati delle note.</p>");const s=Object.values(i).filter((e=>"object"==typeof e&&e.id)),l=s.filter((e=>e.owner===o));console.log(i,s,l),await a("userNotes",l),t.innerHTML="";let c=!1,m=[];Array.isArray(l)&&l.length>0&&(await p()&&await a("userNotes",l),l.forEach((e=>{if(e&&e.book===d&&e.chapter===u&&e.owner===o){c=!0;const{verse:t,title:o="",content:n,id:i}=e;m.push({verse:t,title:o,content:n,noteId:i})}})),m.sort(((e,t)=>e.verse-t.verse)),m.forEach((({verse:o,title:n,content:i,noteId:a})=>{const r=document.createElement("div");r.classList.add("note"),r.setAttribute("data-id",a);const s=e?"../assets/notes/delete/dark.webp":"../assets/notes/delete/light.webp",l=e?"../assets/notes/edit/dark.webp":"../assets/notes/edit/light.webp",c=e?"../assets/notes/share/dark.webp":"../assets/notes/share/light.webp";r.innerHTML=`\n          <div class="verse-number">\n            <h4>Versetto ${o}</h4>\n          </div>\n          <div class="note-body">\n            <h2 class="note-title">${n}</h2>\n            <h3>${i}</h3>\n          </div>\n\n          <div class="note-action-buttons">\n          <button class="delete"><img class="deleteNote_img" src="${s}" width="40px" height="40px"></button>\n          <button class="edit"><img class="edit_img" src="${l}" width="40px" height="40px"></button>\n          <button class="share"><img class="share_img" src="${c}" width="40px" height="40px"></button>\n          </div>\n        `,t.appendChild(r)}))),c||(t.innerHTML="<p>Non hai salvato nessun punto notevole per questo capitolo. Creane uno usando il pulsante in basso a destra con l'icona '+'.</p>")}catch(e){if(e.message.toLowerCase().includes("not existing user token"))return n("Sessione scaduta. Effettua nuovamente il login per continuare."),void i();console.error("Errore nel recupero delle note:",e),n(`Errore: ${e.message}`),t.innerHTML=`<p>Errore nel caricamento delle note. Riprova più tardi.<br>Dettagli: ${e.message}</p>`}finally{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",c.classList.remove("disabled")}}}async function b(){const e=document.querySelector("#noteTitle").value.trim(),i=parseInt(document.querySelector("#verseNumber").value),c=document.querySelector("#noteContent").value.trim();if(!isNaN(i)&&c){g.style.display="none",o();try{const t=localStorage.getItem("userEmail");let o=await l()?await Backendless.Data.of("NotableBiblePoints").findFirst():await r("userNotes");o||(o={NotablePoints:[]});let d=await l()?o.NotablePoints:o;if(f){const t=d.findIndex((e=>e.id===f));if(-1===t)return void n("Errore: impossibile trovare la nota da modificare.");d[t]={...d[t],...e&&{title:e},verse:i,updatedAt:Date.now().toString(),content:c}}else{const o={id:Date.now().toString(),title:e||" ",verse:i,content:c,chapter:parseInt(sessionStorage.getItem("selectedChapter")),book:sessionStorage.getItem("selectedBook"),owner:t};d.push(o)}o.NotablePoints=d,await l()?(await Backendless.Data.of("NotableBiblePoints").save(o),console.log("Nota salvata con successo sul server!")):(await a("userNotes",d.filter((e=>e.owner===t))),console.log("Nota salvata con successo in locale!")),f=null,g.style.display="none",await l()&&(await s("userNotes"),console.log("locale eliminato")),y()}catch(e){console.error("Errore durante il salvataggio/modifica:",e),n("Errore durante il salvataggio. Riprova più tardi.")}finally{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",t()}}else n("Compila tutti i campi correttamente!")}document.querySelector(".openModal").addEventListener("click",(()=>{g.style.display="block"})),document.querySelector(".closeModal").addEventListener("click",(()=>{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",g.style.display="none"})),window.addEventListener("load",y),document.querySelector("#saveNote").addEventListener("click",b),document.addEventListener("click",(e=>{const t=e.target.closest(".note");t&&(t.id="clicked-note",t.requestFullscreen())})),document.addEventListener("fullscreenchange",(()=>{const e=document.fullscreenElement;e&&"clicked-note"===e.id||(document.querySelector("#clicked-note").id="",console.log("Uscito dal fullscreen!"))})),document.querySelector(".notesContainer").addEventListener("click",(e=>{const i=e.target.closest(".note");i&&(e.target.classList.contains("delete")&&async function(e){if(!confirm("Sei sicuro di voler eliminare questa nota?"))return;o(),g.style.display="none";try{const t=e.getAttribute("data-id");if(!t)return void n("Errore: impossibile trovare l'ID della nota.");let o=await l()?await Backendless.Data.of("NotableBiblePoints").findFirst():await r("userNotes");if(console.log(o),await l()&&!o.NotablePoints||!await l()&&!o)return void n("Errore: impossibile trovare le note dell'utente.");const i=await l()?o.NotablePoints.filter((e=>e.id!==t)):o.filter((e=>e.id!==t));await l()?o.NotablePoints=i:o=i;let s=await r("deletedNotes")||[];const c={id:t};s.push(c),await a("deletedNotes",s),await a("userNotes",i.filter((e=>e.owner===localStorage.getItem("userEmail")))),await l()&&await Backendless.Data.of("NotableBiblePoints").save(o),e.remove(),n("Nota eliminata con successo!")}catch(e){console.error("Errore durante l'eliminazione:",e),n("Errore durante l'eliminazione della nota. Riprova più tardi.")}finally{t()}}(i),e.target.classList.contains("share")&&function(e){const t=e.querySelector(".note-title").textContent,o=e.querySelector(".note-body h3").textContent,i=e.querySelector(".verse-number h4").textContent.replace("Versetto ","").trim(),a=`Ho trovato un punto notevole interessante in ${d} ${u}:${i}: ${o}`;navigator.share?navigator.share({title:`Punto notevole: ${t}`,text:a}).then((()=>console.log("Condivisione avvenuta con successo!"))).catch((e=>console.error("Errore durante la condivisione:",e))):function(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),navigator.clipboard.writeText(),document.body.removeChild(t),n("Il testo della nota è stato copiato negli appunti!")}(a)}(i),e.target.classList.contains("edit")&&async function(e){console.log("Editing note..."),document.fullscreenElement&&document.exitFullscreen();f=e.getAttribute("data-id");const t=e.querySelector(".note-title").textContent.trim(),o=e.querySelector(".note-body h3").textContent.trim(),n=e.querySelector(".verse-number h4").textContent.replace("Versetto ","").trim();document.querySelector("#noteTitle").value=t,document.querySelector("#verseNumber").value=n,document.querySelector("#noteContent").value=o,g.style.display="block"}(i))})),document.addEventListener("keypress",(e=>{"Enter"!==e.key||"noteContent"!==e.target.id||/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||(e.preventDefault(),b())}));let f=null;document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(g.style.display="none",f=null,document.removeEventListener("keydown",e))}));new MutationObserver((()=>{window.setTimeout((()=>{0===document.querySelector(".notesContainer").children.length&&(console.log("Tutte le note sono state eliminate"),document.querySelector(".notesContainer").innerHTML="<p>Non hai salvato nessun punto notevole per questo capitolo. Creane uno usando il pulsante in basso a destra con l'icona '+'.</p>")}),500)})).observe(document.querySelector(".notesContainer"),{childList:!0}),c.addEventListener("click",(async()=>{"false"!==sessionStorage.getItem("canRefresh")&&(await l()&&await s("userNotes"),y())}));const h=["Genesi","Esodo","Levitico","Numeri","Deuteronomio","Giosuè","Giudici","Rut","1 Samuele","2 Samuele","1 Re","2 Re","1 Cronache","2 Cronache","Esdra","Neemia","Ester","Giobbe","Salmi","Proverbi","Ecclesiaste","Cantico dei Cantici","Isaia","Geremia","Lamentazioni","Ezechiele","Daniele","Osea","Gioele","Amos","Abdia","Giona","Michea","Naum","Abacuc","Sofonia","Aggeo","Zaccaria","Malachia","Matteo","Marco","Luca","Giovanni","Atti","Romani","1 Corinti","2 Corinti","Galati","Efesini","Filippesi","Colossesi","1 Tessalonicesi","2 Tessalonicesi","1 Timoteo","2 Timoteo","Tito","Filemone","Ebrei","Giacomo","1 Pietro","2 Pietro","1 Giovanni","2 Giovanni","3 Giovanni","Giuda","Rivelazione"],w=document.querySelector("#readChapter")||null;w?.addEventListener("click",(()=>{const e=sessionStorage.getItem("selectedBook"),t=sessionStorage.getItem("selectedChapter"),o=h.indexOf(e);if(-1!==o){const e=(o+1).toString().padStart(2,"0"),n=`${e}${t.padStart(3,"0")}000-${e}${t.padStart(3,"0")}999}`;w.href=`https://www.jw.org/finder?wtlocale=I&prefer=lang&bible=${n}&pub=nwtsty`}else n("C'è stato un errore nel reindirizzamento. Si prega di riprovare più tardi.")}));