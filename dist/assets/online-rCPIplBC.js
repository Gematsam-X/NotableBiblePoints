import{g as e,d as o,s as t}from"./indexedDButils-TR8NEaRF.js";import{t as i}from"./toast-BIaIkxlU.js";import{i as a}from"./isOnline-DgpNA9Wq.js";import"./idb-nMDuyRcf.js";const n=document.querySelector(".refreshNotes");async function s(){try{const n=await e("userNotes")||[],r=await e("deletedNotes")||[];if(0===n.length&&0===r.length)return console.log("Nessuna nota da sincronizzare."),i("Sincronizzazione completata!",2e3),!0;let l;try{l=await Backendless.Data.of("NotableBiblePoints").findFirst()}catch(a){return console.error("Errore nel recupero del record dal server:",a),i(`Errore nel recupero delle tue note dal cloud, continueremo a provare. Non chiudere o ricaricare l'app. Dettagli: ${a}`,4500),window.setTimeout(s,3e3),!1}if(!l||!l.NotablePoints)throw console.log("Nessun record o punti notevoli trovati nel database."),i("Errore: database non trovato. Non riproveremo. Rivolgiti allo sviluppatore se il problema persiste.",3500),new Error("Nessun record trovato nel database, o campo NotablePoints inesistente.");const c=l.NotablePoints;let d=c.filter((e=>!r.some((o=>o.id===e.id))));const u=n.filter((e=>!c.some((o=>o.id===e.id))));return d.push(...u),d=d.map((e=>{const o=n.find((o=>o.id===e.id)),t=c.find((o=>o.id===e.id&&o.owner===e.owner));if(!o||!t)return e;const i=void 0!==o.updatedAt,a=void 0!==t.updatedAt;return i||a?i&&!a?o:!i&&a?t:o.updatedAt>t.updatedAt?o:t:t})),l.NotablePoints=d,await Backendless.Data.of("NotableBiblePoints").save(l),await o("deletedNotes"),await t("userNotes",d),console.log("Sincronizzazione completata con successo!"),i("Sincronizzazione completata!",2e3),!0}catch(a){console.error("Errore durante la sincronizzazione:",a),window.setTimeout(s,1500)}}!function(){let e=!1;setInterval((async()=>{const o=await a();if(!e&&o){console.log("Connessione ripristinata. Sincronizzo i dati..."),i("Sincronizzazione in corso. Non chiudere o ricaricare l'app.",2e3),sessionStorage.setItem("canRefresh","false"),(null==n?void 0:n.classList.contains("disabled"))||null==n||n.classList.add("disabled");await s()?(sessionStorage.setItem("canRefresh","true"),null==n||n.classList.remove("disabled"),console.log("Sincronizzazione completata con successo!")):console.log("Sincronizzazione fallita, riprovo al prossimo ciclo.")}e=o}),3e3)}();
