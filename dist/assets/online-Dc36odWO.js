import{B as e}from"./index-C1EFNDRC.js";import{g as o,d as t,s as i}from"./indexedDButils-TR8NEaRF.js";import{t as a}from"./toast-BIaIkxlU.js";import{i as r,o as n}from"./isOnline-C8sKgvuD.js";import{l as s}from"./logoutAndDelete-DNZTl9xZ.js";import"./idb-nMDuyRcf.js";import"./loadingGif-CLxvH4cC.js";const l=document.querySelector(".refreshNotes");!async function(){async function c(){try{const n=await o("userNotes")||[],l=await o("deletedNotes")||[];if(0===n.length&&0===l.length)return console.log("Nessuna nota da sincronizzare."),a("Sincronizzazione completata!",2e3),!0;let d;try{d=await e.Data.of("NotableBiblePoints").findFirst()}catch(r){return console.error("Errore nel recupero del record dal server:",r),r.message.toLowerCase().includes("relogin user")&&s(),a(`Errore nel recupero delle tue note dal cloud, continueremo a provare. Non chiudere o ricaricare l'app. Dettagli: ${r}`,4500),window.setTimeout(c,3e3),!1}if(!d||!d.NotablePoints)throw a("Errore: database non trovato. Non riproveremo. Rivolgiti allo sviluppatore se il problema persiste.",3500),new Error("Nessun record trovato nel database, o campo NotablePoints inesistente.");const u=d.NotablePoints;let p=u.filter((e=>!l.some((o=>o.id===e.id))));const m=n.filter((e=>!u.some((o=>o.id===e.id))));return p.push(...m),p=p.map((e=>{const o=n.find((o=>o.id===e.id)),t=u.find((o=>o.id===e.id&&o.owner===e.owner));if(!o||!t)return e;const i=void 0!==o.updatedAt,a=void 0!==t.updatedAt;return i||a?i&&!a?o:!i&&a?t:o.updatedAt>t.updatedAt?o:t:t})),d.NotablePoints=p,await e.Data.of("NotableBiblePoints").save(d),await t("deletedNotes"),await i("userNotes",p),console.log("Sincronizzazione completata con successo!"),a("Sincronizzazione completata!",2e3),!0}catch(r){return console.error("Errore durante la sincronizzazione:",r),window.setTimeout(c,1500),!1}}async function d(){console.log("Connessione ripristinata. Sincronizzo i dati..."),a("Sincronizzazione in corso. Non chiudere o ricaricare l'app.",2e3),sessionStorage.setItem("canRefresh","false"),(null==l?void 0:l.classList.contains("disabled"))||null==l||l.classList.add("disabled");await c()?(sessionStorage.setItem("canRefresh","true"),null==l||l.classList.remove("disabled"),console.log("Sincronizzazione completata con successo!")):console.log("Sincronizzazione fallita, riprovo al prossimo evento online.")}await r()&&await d(),await n(d)}();
