const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-CQHKcGVw.js","./isOnline-C8sKgvuD.js"])))=>i.map(i=>d[i]);
import{B as e}from"./index-C1EFNDRC.js";import{i as t}from"./isDarkTheme-DnSvkQ-N.js";import{s as o,h as n}from"./loadingGif-CLxvH4cC.js";import{t as i}from"./toast-BIaIkxlU.js";import{l as a}from"./logoutAndDelete-DNZTl9xZ.js";import{g as r,s,d as l}from"./indexedDButils-TR8NEaRF.js";import{r as c,_ as d,i as u}from"./isOnline-C8sKgvuD.js";import"./theme-CIxG1vPZ.js";import"./idb-nMDuyRcf.js";const m=c("Share",{web:()=>d((()=>import("./web-CQHKcGVw.js")),__vite__mapDeps([0,1]),import.meta.url).then((e=>new e.ShareWeb))}),p=document.querySelector(".refreshNotes"),v=sessionStorage.getItem("selectedBook"),g=parseInt(sessionStorage.getItem("selectedChapter")),b=document.querySelector(".notes-page-title"),y=`Punti notevoli del capitolo ${g} di ${v}`;async function w(){return!!(await u())&&(!(await r("userNotes"))&&(!(await r("userNotes"))||void 0))}b&&(b.textContent=y,window.document.title=`${y} - NotableBiblePoints`);const h=document.querySelector(".modal");async function f(){const o=document.querySelector(".notesContainer");if(o){o.innerHTML="<p>Caricamento in corso...</p>",p.classList.add("disabled");try{const n=localStorage.getItem("userEmail"),a=await w()?(await e.Data.of("NotableBiblePoints").findFirst()).NotablePoints:await r("userNotes");if(console.log(a,"allRecords"),!Array.isArray(a))return i("Errore: i dati non sono in formato corretto."),void(o.innerHTML="<p>Errore nei dati delle note.</p>");const l=Object.values(a).filter((e=>"object"==typeof e&&e.id)),c=l.filter((e=>e.owner===n));console.log(a,l,c),await s("userNotes",c),o.innerHTML="";let d=!1,u=[];Array.isArray(c)&&c.length>0&&(await w()&&await s("userNotes",c),c.forEach((e=>{if(e&&e.book===v&&e.chapter===g&&e.owner===n){d=!0;const{verse:t,title:o="",content:n,id:i}=e;u.push({verse:t,title:o,content:n,noteId:i})}})),u.sort(((e,t)=>e.verse-t.verse)),u.forEach((({verse:e,title:n,content:i,noteId:a})=>{const r=document.createElement("div");r.classList.add("note"),r.setAttribute("data-id",a);const s=t?"../assets/notes/delete/dark.webp":"../assets/notes/delete/light.webp",l=t?"../assets/notes/edit/dark.webp":"../assets/notes/edit/light.webp",c=t?"../assets/notes/share/dark.webp":"../assets/notes/share/light.webp";r.innerHTML=`\n        <span class="close-note">&times;</span>\n          <div class="verse-number">\n            <h4>Versetto ${e}</h4>\n          </div>\n          <div class="note-body">\n            <h2 class="note-title">${n}</h2>\n            <h3>${i}</h3>\n          </div>\n\n          <div class="note-action-buttons">\n          <button class="delete"><img class="deleteNote_img" src="${s}" width="40px" height="40px"></button>\n          <button class="edit"><img class="edit_img" src="${l}" width="40px" height="40px"></button>\n          <button class="share"><img class="share_img" src="${c}" width="40px" height="40px"></button>\n          </div>\n        `,o.appendChild(r)}))),d||(o.innerHTML="<p>Non hai salvato nessun punto notevole per questo capitolo. Creane uno usando il pulsante in basso a destra con l'icona '+'.</p>")}catch(n){if(n.message.toLowerCase().includes("not existing user token"))return i("Sessione scaduta. Effettua nuovamente il login per continuare."),void a();console.error("Errore nel recupero delle note:",n),i(`Errore: ${n.message}`),o.innerHTML=`<p>Errore nel caricamento delle note. Riprova più tardi.<br>Dettagli: ${n.message}</p>`}finally{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",p.classList.remove("disabled")}}}async function S(){const t=document.querySelector("#noteTitle").value.trim(),a=parseInt(document.querySelector("#verseNumber").value),c=document.querySelector("#noteContent").value.trim();if(!isNaN(a)&&c){h.style.display="none",o();try{const o=localStorage.getItem("userEmail");let n=await u()?await e.Data.of("NotableBiblePoints").findFirst():await r("userNotes");n||(n={NotablePoints:[]});let d=await u()?n.NotablePoints:n;if(E){const e=d.findIndex((e=>e.id===E));if(-1===e)return void i("Errore: impossibile trovare la nota da modificare.");d[e]={...d[e],...t&&{title:t},verse:a,updatedAt:Date.now().toString(),content:c}}else{const e={id:Date.now().toString(),title:t||" ",verse:a,content:c,chapter:parseInt(sessionStorage.getItem("selectedChapter")),book:sessionStorage.getItem("selectedBook"),owner:o};d.push(e)}n.NotablePoints=d,await u()?(await e.Data.of("NotableBiblePoints").save(n),console.log("Nota salvata con successo sul server!")):(await s("userNotes",d.filter((e=>e.owner===o))),console.log("Nota salvata con successo in locale!")),E=null,h.style.display="none",await u()&&(await l("userNotes"),console.log("locale eliminato")),f()}catch(d){console.error("Errore durante il salvataggio/modifica:",d),i("Errore durante il salvataggio. Riprova più tardi.")}finally{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",n()}}else i("Compila tutti i campi correttamente!")}document.querySelector(".openModal").addEventListener("click",(()=>{h.style.display="block"})),document.querySelector(".closeModal").addEventListener("click",(()=>{document.querySelector("#noteContent").value="",document.querySelector("#noteTitle").value="",document.querySelector("#verseNumber").value="",h.style.display="none"})),window.addEventListener("load",f),document.querySelector("#saveNote").addEventListener("click",S),document.addEventListener("click",(e=>{const t=e.target.closest(".note");t&&(t.id="clicked-note",t.requestFullscreen())})),document.addEventListener("fullscreenchange",(()=>{const e=document.fullscreenElement;e&&"clicked-note"===e.id||(document.querySelector("#clicked-note").id="",console.log("Uscito dal fullscreen!"))})),document.querySelector(".notesContainer").addEventListener("click",(t=>{const a=t.target.closest(".note");a&&(t.target.classList.contains("delete")&&async function(t){if(!confirm("Sei sicuro di voler eliminare questa nota?"))return;o(),h.style.display="none";try{const o=t.getAttribute("data-id");if(!o)return void i("Errore: impossibile trovare l'ID della nota.");let n=await u()?await e.Data.of("NotableBiblePoints").findFirst():await r("userNotes");if(console.log(n),await u()&&!n.NotablePoints||!(await u())&&!n)return void i("Errore: impossibile trovare le note dell'utente.");const a=await u()?n.NotablePoints.filter((e=>e.id!==o)):n.filter((e=>e.id!==o));await u()?n.NotablePoints=a:n=a;let l=await r("deletedNotes")||[];const c={id:o};l.push(c),await s("deletedNotes",l),await s("userNotes",a.filter((e=>e.owner===localStorage.getItem("userEmail")))),await u()&&await e.Data.of("NotableBiblePoints").save(n),t.remove(),i("Nota eliminata con successo!")}catch(a){console.error("Errore durante l'eliminazione:",a),i("Errore durante l'eliminazione della nota. Riprova più tardi.")}finally{n()}}(a),t.target.classList.contains("share")&&async function(e){const t=e.querySelector(".note-title").textContent,o=e.querySelector(".note-body h3").textContent,n=e.querySelector(".verse-number h4").textContent.replace("Versetto ","").trim(),a=`Ho trovato un punto notevole interessante in ${v} ${g}:${n}: ${o}`;try{await m.share({title:`Punto notevole: ${t}`,text:a,dialogTitle:"Condividi con"})}catch(r){console.error("Errore durante la condivisione:",r),function(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),navigator.clipboard.writeText(),document.body.removeChild(t),i("Il testo della nota è stato copiato negli appunti!")}(a)}}(a),t.target.classList.contains("edit")&&async function(e){console.log("Editing note..."),document.fullscreenElement&&document.exitFullscreen();E=e.getAttribute("data-id");const t=e.querySelector(".note-title").textContent.trim(),o=e.querySelector(".note-body h3").textContent.trim(),n=e.querySelector(".verse-number h4").textContent.replace("Versetto ","").trim();document.querySelector("#noteTitle").value=t,document.querySelector("#verseNumber").value=n,document.querySelector("#noteContent").value=o,h.style.display="block"}(a),t.target.classList.contains("close-note")&&document.exitFullscreen())})),document.addEventListener("keypress",(e=>{"Enter"!==e.key||"noteContent"!==e.target.id||/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||(e.preventDefault(),S())}));let E=null;document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(h.style.display="none",E=null,document.removeEventListener("keydown",e))}));new MutationObserver((()=>{window.setTimeout((()=>{0===document.querySelector(".notesContainer").children.length&&(console.log("Tutte le note sono state eliminate"),document.querySelector(".notesContainer").innerHTML="<p>Non hai salvato nessun punto notevole per questo capitolo. Creane uno usando il pulsante in basso a destra con l'icona '+'.</p>")}),500)})).observe(document.querySelector(".notesContainer"),{childList:!0}),p.addEventListener("click",(async()=>{"false"!==sessionStorage.getItem("canRefresh")&&(await u()&&await l("userNotes"),f())}));const N=["Genesi","Esodo","Levitico","Numeri","Deuteronomio","Giosuè","Giudici","Rut","1 Samuele","2 Samuele","1 Re","2 Re","1 Cronache","2 Cronache","Esdra","Neemia","Ester","Giobbe","Salmi","Proverbi","Ecclesiaste","Cantico dei Cantici","Isaia","Geremia","Lamentazioni","Ezechiele","Daniele","Osea","Gioele","Amos","Abdia","Giona","Michea","Naum","Abacuc","Sofonia","Aggeo","Zaccaria","Malachia","Matteo","Marco","Luca","Giovanni","Atti","Romani","1 Corinti","2 Corinti","Galati","Efesini","Filippesi","Colossesi","1 Tessalonicesi","2 Tessalonicesi","1 Timoteo","2 Timoteo","Tito","Filemone","Ebrei","Giacomo","1 Pietro","2 Pietro","1 Giovanni","2 Giovanni","3 Giovanni","Giuda","Rivelazione"],C=document.querySelector("#readChapter")||null;null==C||C.addEventListener("click",(()=>{const e=sessionStorage.getItem("selectedBook"),t=sessionStorage.getItem("selectedChapter"),o=N.indexOf(e);if(-1!==o){const e=(o+1).toString().padStart(2,"0"),n=`${e}${t.padStart(3,"0")}000-${e}${t.padStart(3,"0")}999}`;C.href=`https://www.jw.org/finder?wtlocale=I&prefer=lang&bible=${n}&pub=nwtsty`}else i("C'è stato un errore nel reindirizzamento. Si prega di riprovare più tardi.")}));
