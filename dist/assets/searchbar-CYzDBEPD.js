import{B as e}from"./index-C1EFNDRC.js";import{t}from"./toast-BIaIkxlU.js";import{g as o,s as i}from"./indexedDButils-TR8NEaRF.js";import{s as n,h as a}from"./loadingGif-CLxvH4cC.js";import"./idb-nMDuyRcf.js";(async()=>{const r=document.getElementById("toggleSearchMode"),s=document.getElementById("search-input"),l=document.getElementById("search-button"),c=document.getElementById("results-modal"),d=document.getElementById("results-content"),m=document.getElementById("close-modal");let u=await o("userNotes");async function h(){if(r.checked){const o=s.value.trim();if(!o)return s.blur(),t("Inserisci una parola o una frase da cercare."),void(c.style.display="none");if(/[<>&"']/.test(o))return s.blur(),t("Inserisci un termine di ricerca valido."),void(c.style.display="none");const r=await async function(o){if(o.length<3)return s.blur(),t("Inserisci almeno 3 caratteri per la ricerca."),void(c.style.display="none");if(!u||!u.length){if(!navigator.onLine)return alert("Connettersi a Internet."),[];n(),u=(await e.Data.of("NotableBiblePoints").findFirst()).NotablePoints.filter((e=>e.owner===localStorage.getItem("userEmail"))),await i("userNotes",u),a()}const r=[],l=o.trim().split(/\s+/).filter(Boolean),d=1===l.length,m=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=d?new RegExp(`\\b${m}`,"gi"):null,p=l.map((e=>{const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\b${t}`,"gi")}));for(const e of u){let t=[],o=[];d&&h&&(t=[...e.content.matchAll(h)],o=[...e.title.matchAll(h)]);let i=0,n=0;for(const r of p)i+=[...e.content.matchAll(r)].length,n+=[...e.title.matchAll(r)].length;const a=t.length+o.length,s=i+n;if(a+s===0)continue;let l=e.title;d&&h&&(l=l.replace(h,(e=>`<mark>${e}</mark>`)));for(const e of p)l=l.replace(e,(e=>`<mark>${e}</mark>`));const c=[],m=e.content.split("\n");for(let e=0;e<m.length;e++){const t=m[e],o=d&&h&&h.test(t),i=p.some((e=>e.test(t)));if(!o&&!i)continue;let n=t;d&&h&&(n=n.replace(h,(e=>`<mark>${e}</mark>`)));for(const e of p)n=n.replace(e,(e=>`<mark>${e}</mark>`));const a=[m[e-2]||"",m[e-1]||"",n,m[e+1]||"",m[e+2]||""].map((e=>e.trim())).filter((e=>e.length>0)).join("<br>");c.push(a)}let u="";if(0===c.length){u=`<div class="content-preview">${e.content.split("\n").slice(0,5).map((e=>e.trim())).filter((e=>e)).join("<br>")}</div>`}const g=`\n      <div class="search-result">\n        <a class="redirect-link"\n           data-book="${e.book}"\n           data-chapter="${e.chapter}"\n           data-id="${e.id}">\n          <h2><strong>${e.book} ${e.chapter}:${e.verse}</strong></h2>\n        </a>\n        <h3><strong>${l}</strong></h3><br>\n        ${c.length>0?`<div class="matched-contexts">${c.join("<br><hr class='dashed'><br>")}</div>`:u}\n      </div>\n      <br><hr class="normal"><br>\n    `;let b=0;a>0&&s>0?b=3:a>0?b=2:s>0&&(b=1),r.push({html:g,matchScore:a+s,priority:b})}return r.sort(((e,t)=>t.priority!==e.priority?t.priority-e.priority:t.matchScore-e.matchScore)),c.style.display="block",r.map((e=>e.html))}(o);if(!(null==r?void 0:r.length))return s.blur(),t(`Nessuna occorrenza trovata per "${o}".`),void(c.style.display="none");d.innerHTML=`<h2>Occorrenze trovate:</h2>${r.join("<br>")}`,s.blur()}else!function(){var e;if(!s)return s.blur(),void t("Inserisci un riferimento biblico valido (es. Genesi 1:1 o Genesi 1 1).");const o=s.value.split(/[\s:]+/),i=o[0].trim(),n=null==(e=o[1])?void 0:e.trim(),a=i.toLowerCase().replace(/\s+/g,""),r=g.filter((e=>e.toLowerCase().replace(/\s+/g,"").startsWith(a)));if(""===a)return s.blur(),void t("Digita il libro biblico ed eventualmente il capitolo nel campo in basso a destra. Puoi anche digitare solo le iniziali del libro (es. 'Gen' per 'Genesi').",4800);if(1===(null==r?void 0:r.length)||"salmo"===a){const e="salmo"===a?"Salmi":r[0];sessionStorage.setItem("selectedBook",e);const t=g.indexOf(e);sessionStorage.setItem("selectedBook",g[t]),n&&!isNaN(n)?(sessionStorage.setItem("selectedChapter",parseInt(n)),window.location.href="notes.html"):window.location.href="chapters.html"}else(null==r?void 0:r.length)>1?(s.blur(),t(`Il testo fornito non è univoco. Forse intendevi: ${r.join(" - ")}`)):(s.blur(),t("Il libro non è stato trovato. Verifica di aver scritto correttamente il nome."))}()}function p(e,t,o){sessionStorage.setItem("selectedBook",e),sessionStorage.setItem("selectedChapter",t),sessionStorage.setItem("selectedNoteId",o),console.log(sessionStorage.getItem("selectedNoteId"),sessionStorage.getItem("selectedChapter")),window.location.href="../html/notes.html"}new MutationObserver((e=>{for(const t of e)"childList"===t.type&&t.addedNodes.length>0&&document.querySelectorAll(".redirect-link").forEach((e=>{e.dataset.listenerAdded||(e.addEventListener("click",(()=>{p(e.dataset.book,e.dataset.chapter,e.dataset.id)})),e.dataset.listenerAdded="true")}))})).observe(c,{childList:!0,subtree:!0}),l.addEventListener("click",h);const g=["Genesi","Esodo","Levitico","Numeri","Deuteronomio","Giosuè","Giudici","Rut","1 Samuele","2 Samuele","1 Re","2 Re","1 Cronache","2 Cronache","Esdra","Neemia","Ester","Giobbe","Salmi","Proverbi","Ecclesiaste","Cantico dei Cantici","Isaia","Geremia","Lamentazioni","Ezechiele","Daniele","Osea","Gioele","Amos","Abdia","Giona","Michea","Naum","Abacuc","Sofonia","Aggeo","Zaccaria","Malachia","Matteo","Marco","Luca","Giovanni","Atti","Romani","1 Corinti","2 Corinti","Galati","Efesini","Filippesi","Colossesi","1 Tessalonicesi","2 Tessalonicesi","1 Timoteo","2 Timoteo","Tito","Filemone","Ebrei","Giacomo","1 Pietro","2 Pietro","1 Giovanni","2 Giovanni","3 Giovanni","Giuda","Rivelazione"];function b(){s.placeholder=r.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."}document.addEventListener("keypress",(e=>{"Enter"===e.key&&document.activeElement===document.getElementById("search-input")&&h()})),s.placeholder=r.checked?"Cerca nelle tue note...":"Cerca un passo biblico...",r.addEventListener("change",(()=>{s.placeholder=r.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."})),b(),r.addEventListener("change",(()=>{b(),localStorage.setItem("searchMode",r.checked)}));const f=localStorage.getItem("searchMode");null!==f&&(r.checked="true"===f,b()),m.addEventListener("click",(()=>{c.style.display="none",s.blur()})),document.addEventListener("click",(e=>{e.target===c&&(c.style.display="none")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(c.style.display="none",s.blur())}))})();
