import{t as e}from"./toast-BIaIkxlU.js";import{g as t,s as o}from"./indexedDButils-TR8NEaRF.js";import{s as n,h as i}from"./loadingGif-CLxvH4cC.js";import"./idb-nMDuyRcf.js";(async()=>{const a=document.getElementById("toggleSearchMode"),s=document.getElementById("search-input"),r=document.getElementById("search-button"),l=document.getElementById("results-modal"),c=document.getElementById("results-content"),d=document.getElementById("close-modal");let m=await t("userNotes");async function u(){if(a.checked){const t=s.value.trim();if(!t)return s.blur(),e("Inserisci una parola o una frase da cercare."),void(l.style.display="none");if(/[<>&"']/.test(t))return s.blur(),e("Inserisci un termine di ricerca valido."),void(l.style.display="none");const a=await async function(t){if(t.length<3)return s.blur(),e("Inserisci almeno 3 caratteri per la ricerca."),void(l.style.display="none");if(!m||!m.length){if(!navigator.onLine)return alert("Connettersi a Internet."),[];n(),m=(await Backendless.Data.of("NotableBiblePoints").findFirst()).NotablePoints.filter((e=>e.owner===localStorage.getItem("userEmail"))),await o("userNotes",m),i()}const a=[],r=t.trim().split(/\s+/).filter(Boolean),c=1===r.length,d=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=c?new RegExp(`\\b${d}`,"gi"):null,h=r.map((e=>{const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\b${t}`,"gi")}));for(const e of m){let t=[],o=[];c&&u&&(t=[...e.content.matchAll(u)],o=[...e.title.matchAll(u)]);let n=0,i=0;for(const a of h)n+=[...e.content.matchAll(a)].length,i+=[...e.title.matchAll(a)].length;const s=t.length+o.length,r=n+i;if(s+r===0)continue;let l=e.title;c&&u&&(l=l.replace(u,(e=>`<mark>${e}</mark>`)));for(const e of h)l=l.replace(e,(e=>`<mark>${e}</mark>`));const d=[],m=e.content.split("\n");for(let e=0;e<m.length;e++){const t=m[e],o=c&&u&&u.test(t),n=h.some((e=>e.test(t)));if(!o&&!n)continue;let i=t;c&&u&&(i=i.replace(u,(e=>`<mark>${e}</mark>`)));for(const e of h)i=i.replace(e,(e=>`<mark>${e}</mark>`));const a=[m[e-2]||"",m[e-1]||"",i,m[e+1]||"",m[e+2]||""].map((e=>e.trim())).filter((e=>e.length>0)).join("<br>");d.push(a)}let p="";if(0===d.length){p=`<div class="content-preview">${e.content.split("\n").slice(0,5).map((e=>e.trim())).filter((e=>e)).join("<br>")}</div>`}const g=`\n      <div class="search-result">\n        <a class="redirect-link"\n           data-book="${e.book}"\n           data-chapter="${e.chapter}"\n           data-id="${e.id}">\n          <h2><strong>${e.book} ${e.chapter}:${e.verse}</strong></h2>\n        </a>\n        <h3><strong>${l}</strong></h3><br>\n        ${d.length>0?`<div class="matched-contexts">${d.join("<br><hr class='dashed'><br>")}</div>`:p}\n      </div>\n      <br><hr class="normal"><br>\n    `;let b=0;s>0&&r>0?b=3:s>0?b=2:r>0&&(b=1),a.push({html:g,matchScore:s+r,priority:b})}return a.sort(((e,t)=>t.priority!==e.priority?t.priority-e.priority:t.matchScore-e.matchScore)),l.style.display="block",a.map((e=>e.html))}(t);if(!(null==a?void 0:a.length))return s.blur(),e(`Nessuna occorrenza trovata per "${t}".`),void(l.style.display="none");c.innerHTML=`<h2>Occorrenze trovate:</h2>${a.join("<br>")}`,s.blur()}else!function(){var t;if(!s)return s.blur(),void e("Inserisci un riferimento biblico valido (es. Genesi 1:1 o Genesi 1 1).");const o=s.value.split(/[\s:]+/),n=o[0].trim(),i=null==(t=o[1])?void 0:t.trim(),a=n.toLowerCase().replace(/\s+/g,""),r=p.filter((e=>e.toLowerCase().replace(/\s+/g,"").startsWith(a)));if(""===a)return s.blur(),void e("Digita il libro biblico ed eventualmente il capitolo nel campo in basso a destra. Puoi anche digitare solo le iniziali del libro (es. 'Gen' per 'Genesi').",4800);if(1===(null==r?void 0:r.length)||"salmo"===a){const e="salmo"===a?"Salmi":r[0];sessionStorage.setItem("selectedBook",e);const t=p.indexOf(e);sessionStorage.setItem("selectedBook",p[t]),i&&!isNaN(i)?(sessionStorage.setItem("selectedChapter",parseInt(i)),window.location.href="notes.html"):window.location.href="chapters.html"}else(null==r?void 0:r.length)>1?(s.blur(),e(`Il testo fornito non è univoco. Forse intendevi: ${r.join(" - ")}`)):(s.blur(),e("Il libro non è stato trovato. Verifica di aver scritto correttamente il nome."))}()}function h(e,t,o){sessionStorage.setItem("selectedBook",e),sessionStorage.setItem("selectedChapter",t),sessionStorage.setItem("selectedNoteId",o),console.log(sessionStorage.getItem("selectedNoteId"),sessionStorage.getItem("selectedChapter")),window.location.href="../html/notes.html"}new MutationObserver((e=>{for(const t of e)"childList"===t.type&&t.addedNodes.length>0&&document.querySelectorAll(".redirect-link").forEach((e=>{e.dataset.listenerAdded||(e.addEventListener("click",(()=>{h(e.dataset.book,e.dataset.chapter,e.dataset.id)})),e.dataset.listenerAdded="true")}))})).observe(l,{childList:!0,subtree:!0}),r.addEventListener("click",u);const p=["Genesi","Esodo","Levitico","Numeri","Deuteronomio","Giosuè","Giudici","Rut","1 Samuele","2 Samuele","1 Re","2 Re","1 Cronache","2 Cronache","Esdra","Neemia","Ester","Giobbe","Salmi","Proverbi","Ecclesiaste","Cantico dei Cantici","Isaia","Geremia","Lamentazioni","Ezechiele","Daniele","Osea","Gioele","Amos","Abdia","Giona","Michea","Naum","Abacuc","Sofonia","Aggeo","Zaccaria","Malachia","Matteo","Marco","Luca","Giovanni","Atti","Romani","1 Corinti","2 Corinti","Galati","Efesini","Filippesi","Colossesi","1 Tessalonicesi","2 Tessalonicesi","1 Timoteo","2 Timoteo","Tito","Filemone","Ebrei","Giacomo","1 Pietro","2 Pietro","1 Giovanni","2 Giovanni","3 Giovanni","Giuda","Rivelazione"];function g(){s.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."}document.addEventListener("keypress",(e=>{"Enter"===e.key&&document.activeElement===document.getElementById("search-input")&&u()})),s.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico...",a.addEventListener("change",(()=>{s.placeholder=a.checked?"Cerca nelle tue note...":"Cerca un passo biblico..."})),g(),a.addEventListener("change",(()=>{g(),localStorage.setItem("searchMode",a.checked)}));const b=localStorage.getItem("searchMode");null!==b&&(a.checked="true"===b,g()),d.addEventListener("click",(()=>{l.style.display="none",s.blur()})),document.addEventListener("click",(e=>{e.target===l&&(l.style.display="none")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(l.style.display="none",s.blur())}))})();
